# 확정적 스트림 처리

- 여러 파티셔네서 이벤트를 소비할 경우 이벤트 처리 순서는 어떻게 정하는가 ?
- 비순차 이벤트, 지각 이벤트는 어떻게 처리하는가 ?
- 스트림을 실시간에 가깝게 처리하는 경우와 스트림의 맨 처음부터 처리하는 두 가지 경우, 어떻게 마이크로서비스는 처리 결과를 확정적으로 생산할 수 있는가 ?

## 타임스탬프

타임스탬프를 이용하면 이벤트 처리 시점의 선후 관계를 파악할 수 있기 때문에, 이벤트가 정확한 순서대로 처리됐는지 알 수 있다.
아래는 타임스탬프와 관련된 몇 가지 중요한 개념들이다.

- 이벤트 시간
  - 이벤트 발생 시저메 프로듀서가 이벤트에 할당한 로컬 타임스탬프
- 브로커 인입 시간
  - 이벤트 브로커가 이벤트에 할당한 타임스탬프
- 컨슈머 인입 시간
  - 이벤트가 컨슈머에 인입된 시간
- 처리 시간
  - 컨슈머가 이벤트 처리를 완료한 월클럭 시간

<img width="680" alt="스크린샷 2024-05-21 오후 9 15 19" src="https://github.com/A-Little-Bit-Tech-Frontiers/Building-Event-Driven-Microservices-Book/assets/87420630/afbf5886-7fd2-4541-92db-cf9e6ab20a95">

### 타임스탬프 찍힌 이벤트 처리

타임스탬프를 이용하면 여러 이벤트 스트림과 파티션에 분산된 이벤트를 일관된 시간 순서대로 처리할 수 있다. <br>
오프셋으로 순서를 비교하는 것은 단일 이벤트 스트림 파티션 내에서만 가능하며, 실제로는 여러 다른 이벤트 스트림에서 이벤트를 받아 처리하는 구조가 일반적이다.

<br>

## 이벤트 스케줄링과 확정적 처리

**이벤트 스케줄링**은 여러 입력 파티션에서 이벤트를 소비할 때 다음에 처리할 이벤트를 선택하는 프로세스이다. <br>
비즈니스 로직에서 이벤트를 소비/처리하는 순서가 중요할 경우, 마이크로서비스에서 이벤트 스케줄링 코드를 구현해야 한다.

<br>

## 비순차 이벤트와 지각 이벤트

이벤트 스트리메서 자신의 앞에 있는 이벤트보다 타임스탬프가 더 큰 이벤트를 **비순차 이벤트**라고 한다. <br>
비순차 이벤트는 비즈니스 수준에서 그 처리 방법을 구체화하고 지연과 확정성 중 어느 쪽을 더 우선할지 결정해야 한다.

## 지각 이벤트 처리

- 이벤트 폐기
  - 이벤트를 그냥 버린다.
- 대기
  - 일정 시간 동안 윈도 결과 출력을 늦춘다. 지연 시간이 늘어나는 만큼 확정성을 노핀다.
- 유예 기간
  - 윈도가 완료된 것으로 간주되면 곧바로 윈도 결과를 출력한다. 그런 다음 미리 정해진 유예 기간 동안 윈도를 가용한 상태로 열어둔다.
























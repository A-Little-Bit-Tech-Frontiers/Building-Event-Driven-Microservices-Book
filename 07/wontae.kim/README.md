# 7. 상태 저장 스트리밍

이벤트 기반 마이크로서비스를 운영하다 보면 비즈니스 요건 상 어느정도의 상태 유지가 필요하다.

기본적인 상태 유지를 위해서는 **구체화된 상태(공통 비즈니스 도메인, 엔티티)** 를 **상태 저장소(DB, Storage)** 에 저장하게 되는데, 이 상태 저장소는 필요에 따라 로컬, 외부 스토리지로 분류될 수 있다.

상태 저장소를 재구성 해야 하는 경우, 상태를 저장할 때 사용했던 이벤트 스트림을 이원화 하는 **체인지로그** 가 필요한데, 이 체인지로그의 데이터는 이벤트 스트림으로 변환할 수 있는 상태 사본으로 둘 수 있다. 

### 내부 상태 저장소에 상태 구체화

컨테이너 또는 VM 환경에서 내부 DB 구현에 저장하는 방법이다. 이렇게 내부 상태를 저장하면 인스턴스의 컴퓨팅 리소스에 확장의 책임을 떠넘길 수 있다. 내부 상태는 노드 자신만 가지고 있을 수도 있고, 전역 상태로 같은 스트림의 파티션을 구독하는 노드들에게 전파할 수 있다. 고가용성 상태 저장소 활용을 위해서는 **핫 레플리카**를 고려할 수도 있지만, 디스크 용량을 그 만큼 많이 소비하기 때문에 트레이드 오프가 있다.

다만 컴퓨팅 리소스의 볼륨 스토리지에 의존하기 때문에 서비스의 실행 중에는 볼륨 조정이 불가능하다. 또한, RAM 이 부족할 경우 디스크의 용량을 Swap 하는 등 부가적인 용량 사용이 있기 때문에 필요 이상의 용량을 설정해야 할 수 있다.

### 외부 상태 저장소에 상태 구체화

동일 네트워크(서브넷 등)에 연결되는 외부 DB 등으로 상태를 저장한다.

상태를 저장할 때 외부 DB 와 네트워킹을 하기 때문에 시간이 더 소요되어 로컬 저장소보다는 성능이 저하된다. 당연하지만 외부 DB 또한 호스팅, 컴퓨팅 비용이 있어 이용료가 발생한다. **데이터 지역성이 완전하기 때문에**, 어떤 인스턴스의 상태를 구체화 하는지 잘 확인해야 한다.

복구를 위한 방법으로는 소스 스트림 초기 시점부터 소비, 체인지로그 사용, **스냅샷 사용** 등이 있다. 스냅샷은 많은 SaaS, PaaS 서비스에서 간단한 복구를 위한 방법으로 제공하는 경우가 많다. 물론 스냅샷으로 복구하려면 멱등성이 보장되어야 한다.

### 실제로 Once-Transaction 처리하기

Kafka 같은 서비스는 원자적인 ‘트랜잭션’ 기능을 명시적으로 제공하여 강력한 경쟁력을 가지지만, 이외에는 거의 제공하지 않는 경우가 대부분이다. Kafka 를 사용하지 않는다면, **멱등성 쓰기**를 제공하는 서비스를 사용하는 것이 좋다. 멱등하게 쓰게 되면 프로듀서나 브로커가 실패해도 한번만 이벤트를 보장할 수 있다.

트랜잭션 기능을 제공하는 Kafka 는 프로듀서에서 예외 발생 시 체인지로그와 이전 오프셋을 통해 스트림의 오프셋을 복구한다.

트랜잭션 기능이 없는 이벤트 브로커 들은 **중복 이벤트**에 특히 유의해야 한다. 이런 경우는 보통 **프로듀서의 처리와  이벤트 브로커의 처리가 불일치할 때 발생**한다. 이벤트는 등록했는데 프로듀서에서 예외가 발생하거나, 프로듀서가 ACK 신호를 받지 못해 재시도를 하는 경우 등이 있다. 멱등한 이벤트의 경우는 크게 문제될 부분은 아니지만, 멱등하지 않거나 중복되면 안되는 프로세스라면 중복 이벤트의 보호처리를 해야 한다.

이런 경우 프로듀서에서 중복 방지 프로세스를 만들어야 하는데, 이벤트 발행 시점에 카디널리티(고유성)가 높은 이벤트의 **완전한 고유 ID** 를 만드는 방법이 있다.

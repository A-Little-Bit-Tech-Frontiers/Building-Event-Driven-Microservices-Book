# 4. 기존 시스템에 이벤트 기반 아키텍처 통합

### 데이터 해방

교차 도메인의 데이터 셋을 식별해서 각 이벤트 스트림에 발행하도록 하는 Migration Strategy 의 일부이다.

End-to-End 데이터 소싱 의존성을 스트림으로 변경함으로써, 각 애플리케이션은 프로듀서와 컨슈머의 역할에만 관심을 갖고 처리할 수 있다.

이렇게 데이터 해방을 하기 위해서는 반드시 식별된 데이터 셋들은 애플리케이션 간에 완전하게 동기화 되어야 하고 이를 위한 요건은 최종 일관성으로 한정된다.

최종 일관성을 달성하기 위해 여러 CDC(change-data capture) 매커니즘을 사용할 수 있는데, 크게 쿼리 / 로그 / 테이블 기반 패턴으로 분류할 수 있다.

### 쿼리 기반 CDC 패턴으로 데이터 해방

쿼리 기반 패턴의 핵심은 벌크 쿼리를 조회하고 변경분을 이벤트로 발행하는 방법이다.

### CDC 로그 패턴으로 데이터 해방

특정 DB 에만 존재하는 CDC 로그 기능을 활용하는 방법이다. 바이너리 로그(MySQL), white-ahead log(PostgreSQL) 등이 있다. 이 기능을 사용하는 목적은 **시간에 따른 데이터 셋에 가해진 로그를 붙임 전용 로그 형태로 남기는 것이다.** 이를 위한 도구로 데베지움(Debezium), 맥스웰 등이 있는데, 이런 도구의 설정을 사용하면 이벤트 스트림에 레코드를 생산하게 할 수 있다.

### 아웃박스 테이블로 데이터 해방 ***

아웃박스 패턴은 기본적으로 데이터 저장소에서 생긴 내부 데이터의 업데이트를 다른 테이블에 로그처럼 레코드를 쌓는 방법이다. 이 변경 로그 테이블을 이벤트 스트림 처럼 사용할 수 있다.

**트랜잭션 내부에서 이벤트 발행을 수행할 경우, 완전한 동작의 일치를 보장할 수는 없다.** 왜냐하면 트랜잭션은 실패하는데 이벤트 발행은 완료될 수도 있고(이 경우 이벤트 발행이 선행되고 데이터 액세스가 이후에 실패할 경우) 반대의 경우(이벤트 발행 시 스트림에 문제가 생기거나 네트워크 문제 등)도 충분히 실패의 여지가 있기 때문이다.

그렇기 때문에 아웃박스 패턴은 **아웃박스 테이블에 레코드를 생산하는 작업의 성공 유무가 트랜잭션에 영향을 미치기 때문에** 아웃박스 테이블 기반으로 **성공한 변경에 대해서만 이벤트를 발행할 수 있게 된다.**

# 마이크로서비스 워크플로 구축

**워크플로**는 논리적 분기, 보상 액션 등 비즈니스 프로세스를 구성하는 특정한 작업들을 지칭한다. <br>
일반적으로 워크플로는 여러 마이크로서비스가 각자 경계 컨텍스트를 가지고 어떤 태스크를 수행한 뒤 다운스트림 컨슈머에게 새 이벤트를 전달하는 식이다.

## 코레오그래피 패턴

마이크로서비스는 업스트림 프로듀서나 후속 다운스트림 컨슈머와는 완전히 독립적으로, 일체의 차단과 대기없이 입력 이벤트가 도착하는대로 반응한다. <br>
프로듀서는 자신의 데이터를 어느 컨슈머가 소비할지, 컨슈머가 그 데이터에 어떤 비즈니스 로직을 적용하고 어떤 작업을 실행하는지 모른다. <br>
코레오그래피 패턴을 적용하면 시스템이 느슨하게 결합되고, 새로운 마이크로서비스도 쉽게 추가/삭제할 수 있다.


### 코레오그래피 워크플로의 생성과 수정

새로운 단계를 워크플로 끝부분에 추가하는 것은 간단하지만, 중간에 단계를 삽입하거나 워크플로 순서를 바꾸면 문제가 될 수 있다. <br>
또 서비스간의 관계는 워크플로 컨텍스트 외부에서는 이해하기 어려워서, 서비스 수가 증가할수록 사정은 더 나빠진다.

<img width="692" alt="스크린샷 2024-05-29 오후 9 08 10" src="https://github.com/A-Little-Bit-Tech-Frontiers/Building-Event-Driven-Microservices-Book/assets/87420630/933b71ab-41dd-438c-80d7-ae7944ad83c1">

<br>

## 오케스트레이션 패턴

중앙의 오케스트레이터가 하위의 워커 마이크로서비스에게 명령을 내린 뒤 응답을 기다리는 방식이다. <br>
오케스트레이터 마이크로서비스는 주어진 비즈니스 프로세스의 전체 워크플로 로직을 알고 있으며, 워커 마이크로서비스들에게 특정 이벤트를 전달해서 무슨 일을 할지 알린다.

<img width="655" alt="스크린샷 2024-05-29 오후 9 07 43" src="https://github.com/A-Little-Bit-Tech-Frontiers/Building-Event-Driven-Microservices-Book/assets/87420630/564e44ef-c823-458a-abb7-50e3e9e5add9">

<br>

## 분산 트랜잭션

**분산 트랜잭션**은 둘 이상의 마이크로서비스에 걸쳐있는 트랜잭션을 말한다. <br>
마이크로서비스는 각자 트랜잭션에서 자신의 분량을 처리하되, 트랜잭션이 중단되어 되돌아갈 경우 처리한 내용을 되돌린다. <br>
EDA에서 분산 트랜잭션은 보통 **사가**라고 하며, 코레오그래피 패턴이나 오케스트레이터 패턴으로 구현한다. <br>
사가 패턴에서는 사가에 참여하는 마이크로서비스가 각자 트랜잭션에서 자신이 처리한 분량을 알아서 되돌릴 수 있어야 한다.

### 코레오그래피 예시

<img width="701" alt="스크린샷 2024-05-29 오후 9 11 19" src="https://github.com/A-Little-Bit-Tech-Frontiers/Building-Event-Driven-Microservices-Book/assets/87420630/ed7854f7-d5a4-40c3-94cd-df011edb0d6c">

### 오케스트레이션 예시

<img width="524" alt="스크린샷 2024-05-29 오후 9 12 16" src="https://github.com/A-Little-Bit-Tech-Frontiers/Building-Event-Driven-Microservices-Book/assets/87420630/83b82535-9380-4308-be65-f9eac1d66180">

















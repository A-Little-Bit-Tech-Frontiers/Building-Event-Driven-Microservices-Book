# 1. 왜 이벤트 기반 마이크로서비스인가?

### 이벤트 기반 마이크로서비스

서비스 지향 아키텍처(SOA) 에서도 이미 서비스 간 직접 비동기 통신을 함으로써 마이크로서비스의 개념을 사용해 왔지만, 현대적인 이벤트 기반 마이크로서비스 에서는 시스템이 이벤트를 생산/소비 하는 방식으로 통신하는 방법을 기반으로 한다.

### 도메인과 경계 컨텍스트

도메인은 어떤 문제를 정의하는 공간을 의미하고, 메인 도메인을 기준으로 문제 공간의 구성에 따라 다시 하위 도메인으로 분할될 수 있다. 도메인은 각자가 강한 응집도를 가져야 하며, 이렇게 만들어진 도메인을 기준으로 경계 컨텍스트를 설정하고 서로 느슨하게 결합한다.

경계 컨텍스트를 잘 설정해 놓으면, 팀 별로 느슨하게 결합하여 강하게 응집된 마이크로서비스의 구현체를 쉽게 바꿀수 있고, 의존 관계가 크게 줄어들어 각 팀의 맡은 영역에 집중할 수 있게 된다.

- **경계 컨텍스트 (Bounded Context)**
    
    경계 컨텍스트는 명확하게 의미를 결정하는 정의가 없다. 용어를 기준으로 의미가 달라질 수 있는데, 기본적으로 “도메인 모델의 경계” 를 구분하는 공간으로 생각할 수 있다. 그렇기 때문에 경계 컨텍스트는 **비즈니스 요건을 중심으로 설정**해야 한다. 이 경계 컨텍스트는 실제로 기능을 제공하는 물리적 시스템이며 이 안에서 도메인 모델을 구현한다.
    
    도메인을 기준으로 경계 컨텍스트를 구분하자면, 메인 도메인을 감싸는 영역을 경계 컨텍스트로 설정할 수 있고, 하위 도메인도 자연스럽게 상위 도메인이 속한 경계 컨텍스트 내에서 기능을 구현하게 된다. 단, 하위 도메인 또한 독립적인 도메인이고 각자가 경계 컨텍스트를 가지기 때문에, 하위 도메인 간에 역할이 섞이지 않도록 해서 강한 응집도를 유지할 수 있도록 해야 한다.
    

### 통신 구조

- **비즈니스를 구성하는 통신 구조**
    - 비즈니스 통신 구조 : 팀과 부서간의 통신을 각 팀의 책임에 따라 결정하는 것
    - 구현 통신 구조 : 하위 도메인 모델에 대해 조직에서 규정한 데이터와 로직을 이용해 신속하고 효율적인 업무 수행을 위해 비즈니스 프로세스, 데이터 구조, 시스템 설계를 정규화 한 것
    - 데이터 통신 구조 : 비즈니스 전반에 걸쳐 구현체 간 데이터를 주고 받는 프로세스 (이메일, 메시징 등)

콘웨이의 법칙에 따르면, **시스템 구조는 시스템을 설계하는 조직의 통신 구조를 따라갈 수 밖에 없다**고 한다.

만약 통신 구조를 제대로 확립하지 않고 기존 시스템을 확장하고 종국에는 분리하게 될 경우, 취약한 통신 구조로 인해 서비스를 분리할 수 없는 지경에 이를 수 있다.

- **이벤트 기반 통신 구조**
    
    이벤트 스트림을 통해 각 서비스는 이벤트라는 “사실 진술서”를 발행하고, 소비하게 된다. 이벤트는 각 조직에서 일어난 모든 일을 정규화 한다. 프로듀서와 컨슈머는 정규화된 이벤트에 대해 모든 로직을 캡슐화 해야 한다. 직접적인 통신과 달리, 이벤트를 통해 각자 맡은 경계 컨텍스트의 일을 처리하기만 하면 된다. 또한, 이벤트는 구현체가 아니기 때문에 비즈니스 요건에 따라 통신 구조를 유연하게 변경할 수 있다.
    

### 비동기 이벤트 기반 마이크로서비스 vs 동기식 마이크로서비스

이벤트 기반 마이크로서비스의 장점

- 세분성
- 확장성
- 기술 유연성
- 비즈니스 요건 유연성
- 느슨한 결합
- 지속적 전달 지원
- 우수한 시험성
    - 필요한 엔드포인트를 Mocking 하여 코드 커버리지는 적절히 유지하기 쉽다.

동기식 마이크로서비스의 장점

- A/B 테스트에 유리
- 작업 추적에 유리
- 인적 자원 충전이 수월

동기식 마이크로서비스의 단점

- 높은 점대점 결합도
- 의존적인 확장 (부하가 가변적일때 팬아웃 문제 발생)
- API Verserning, Dependency 관리
    - 특정한 API Address 에 의존하기 때문에 변경에 취약하다.
- 구현체에 종속되는 데이터 접근성
- 분산 모놀리스
- 테스트 (?)
    - 포괄적인 테스트를 위해 반대편 엔드포인트가 가동 중이어야 하기 때문에 테스트가 어렵다.
    - **추가적인 내 생각**
        - 사실 내용 중 이것이 단점이라고 꼽히는 이유를 모르겠다. 이벤트 기반 마이크로서비스의 장점 중 “우수한 시험성” 에서는 모의하기 좋다는 것이 장점으로 꼽히는데, 동기식 마이크로서비스 또한 점대점 호출을 똑같이 모의 할 수 있다. 반면, 전자는 통합테스트를 수행하려면 이벤트 스트림이 가동중이어야 하지 않나 싶어서 오히려 비동기 마이크로서비스의 단점이 아닌가 싶었다.
- 서비스 실패 처리 필요 (내결함성 허용 패턴 적용)
    - 단, 내결함성에 대한 대비는 동기식 마이크로서비스만 해당되는 것이 아니라, 비동기식 마이크로 서비스에서도 메시징을 사용하지 않는 요청 (HTTP GET) 의 경우 필수적인 설계이다.
    - 마이크로서비스 내결함성에 대한 참고 : https://medium.com/cloud-native-daily/fault-tolerance-in-microservices-architecture-patterns-principles-and-techniques-explained-20cfa3d7f98f
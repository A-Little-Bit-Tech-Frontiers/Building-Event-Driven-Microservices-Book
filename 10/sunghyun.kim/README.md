# 기본 프로듀서/컨슈머 마이크로서비스 (Basic Producer and Consumer)

기본 프로듀서/컨슈머(BPC)는 하나 이상의 이벤트 스트림에서 이벤트를 받아 비즈니스 로직을 적용해 가공하고, 필요시 출력 이벤트 스트림에 이벤트를 내보내는 마이크로 서비스이다. <br>
기본적인 컨슈머 클라이언트는 이벤트 스케줄링, 워터마크, 구체화 매커니즘, 체인지로그, 로컬 상태 저장소를 이용한 처리 인스턴스의 수평적 확장 등의 작업은 하지 않는다. <br>
프로듀서/컨슈머 클라이언트는 가장 널리 쓰이는 언어로 쉽게 구현할 수 있고, EDA를 처음 시작하는 사람의 인지 오버헤드가 낮다.

## BPC의 알맞은 용도는 ?

BPC 마이크로서비스는 완전한 기능을 갖춘 프레임워크에 내장된 컴포넌트는 제공하지 않지만, 폭넓은 비즈니스 요건을 충족할 수 있다. <br>
확정적 이벤트 스케줄링이 필요없는 상태 저장 패턴이나, 상태 비저장 변환같은 단순한 패턴은 구현하기 쉽다.

### 기존 레거시 시스템과 통합

BPC 클라이언트를 코드베이스에 통합하는 식으로 레거시 시스템을 이벤트 기반 아키텍처에 도입할 수 있다. <br>
이런 통합 작업은 대개 EDA를 도입하는 초기에 시작되며, 레거시 시스템을 이벤트 기반 체계로 전환하는 전략의 일부가 되기도 한다.

이벤트 스트림에서 데이터를 생산/소비하도록 레거시 코드베이스를 안전하게 수정할 수 없는 경우도 있는데, <br>
이런 경우는 기존 코드베이스에 영향을 끼치지 않고 일부 이벤트 기반 기능을 적용할 수 있는 **사이드카 패턴**을 이용한다.

#### 사이드카 패턴

<img width="684" alt="스크린샷 2024-06-09 오후 2 15 42" src="https://github.com/A-Little-Bit-Tech-Frontiers/Building-Event-Driven-Microservices-Book/assets/87420630/23fbc63e-a2c7-47d6-a3f7-84b372c6897e">
<img width="708" alt="스크린샷 2024-06-09 오후 2 15 45" src="https://github.com/A-Little-Bit-Tech-Frontiers/Building-Event-Driven-Microservices-Book/assets/87420630/5a05c18f-d44a-46bd-b21e-755fc4b29eea">

사이드카는 자체 컨테이너에 두지만, 프론트엔트 서비스의 단일 배포체의 일부분이 되어야 하며, 통합된 사이드카가 잘 작동하는지 반드시 별도 테스트를 해봐야 한다.

### 이벤트 순서와 무관한 상태 저장 비즈니스 로직

많은 비즈니스 프로세스는 이벤트가 도착하는 순서에 대해 특별한 요건이 없지만, 최종적으로 필요한 모든 이벤트가 도착해야 한다는 요건은 있다. <br>
이것을 **게이팅 패턴**이라고 하고, BPC로 구현하기 좋다

#### 예시: 도서 출판

- 콘텐츠
  - 도서 콘텐츠는 당연히 작성되어야 한다.
- 표지
  - 표지 그림도 넣어야 한다.
- 단가
  - 지역, 출판 포맷에 따라 단가도 책정되어야 한다.

위 세 이벤트는 제각기 로직을 일으키는 역할을 한다. <br>
세 스트림 중 하나로 새 이벤트가 들어오면, 일단 테이블에 구체화한 뒤 다른 두 테이블을 하나씩 검사해서 나머지 두 이벤트가 있는지 확인한다.

<img width="653" alt="스크린샷 2024-06-09 오후 2 20 21" src="https://github.com/A-Little-Bit-Tech-Frontiers/Building-Event-Driven-Microservices-Book/assets/87420630/035f97f9-78ec-4383-a557-9af9de6142a7">


### 데이터 레이어가 너무 많은 일을 하는 경우

BPC는 지리공간 데이터 저장소, 자유 텍스트 검색, 머신러닝 등 대부분의 비즈니스 로직이 하부 데이터 레이어에서 처리될때에도 적합하다. <br>
가령, 쇼핑몰 웹사이트에서 스크랩한 신제품이 인입되어 BPC 마이크로서비스로 분류하고 백엔드 데이터 레이어를 배치 훈련된 머신러닝 분류기로 사용할 수 있다.











